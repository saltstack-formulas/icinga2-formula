{% import_yaml "icinga2/defaults.yaml" as defaults %}
{% import_yaml "icinga2/osfamilymap.yaml" as osfamilymap %}
{% import_yaml "icinga2/osmap.yaml" as osmap %}

{%- set icinga2 = salt['grains.filter_by'](
    defaults, 
    merge=salt['grains.filter_by'](
        osfamilymap,
        grain='os_family',
        merge=salt['grains.filter_by'](
            osmap,
            grain='os',
            merge=salt['pillar.get']('icinga2:lookup', {}),
        ),
    ),
    base='icinga2')
%}

{%- macro feature(name, enable) %}
{%-   set action = 'enable' if enable else 'disable' %}
{%-   set category = 'Enabled' if enable else 'Disabled' %}
"icinga2_feature_{{ name }}":
  cmd.run:
    - name: icinga2 feature {{ action }} {{ name }}
    - unless: "icinga2 feature list | grep '^{{ category }} features:.* {{ name }}\\( \\|$\\)'"
    - watch_in:
      - service: icinga2_service_restart
{%- endmacro %}

{%- macro module(name, repo, branch, path, enable) %}
{%-   set action = 'enable' if enable else 'disable' %}
"icingaweb2_module_{{ name }}":
  {% if action == "enable" %}
  git.latest:
    - name: {{ repo }}
    - target: {{ path }}
    - rev: {{ branch }}
    - require:
      - pkg: icinga2-web2
  {% endif %}
  cmd.run:
    - name: icingacli module {{ action }} {{ name }}
    - unless: "icingacli module list | grep '^{{ name }} .* enabled '"
    {% if action == "enable" %}
    - require:
      - git: icingaweb2_module_{{ name }}
    {% endif %}
{%- endmacro %}
